services:
  - type: web
    name: price-backend
    env: docker
    region: oregon
    plan: free
    dockerfilePath: ./backend/Dockerfile
    buildContext: ./backend
    autoDeploy: true
    buildCommand: |
      pip install -r requirements.txt
      python manage.py collectstatic --noinput || true
    startCommand: |
      gunicorn price_project.wsgi:application --bind 0.0.0.0:$PORT --workers 3
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: price_project.settings
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: POSTGRES_DB
        value: price_db
      - key: POSTGRES_USER
        value: price_user
      - key: POSTGRES_PASSWORD
        value: price_pass
      - key: DATABASE_URL
        fromDatabase:
          name: price-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: price-redis
          type: redis
          property: connectionString
      - key: OPEN_SOURCES
        value: '["api_partner","sftp_feed"]'
      - key: EXIT_TARGETS
        value: '["api_clients","webhooks"]'
      - key: TEMP_DIR
        value: /tmp/price_api_temp
      - key: X_API_KEY
        value: dev-api-key
    healthCheckPath: /api/docs/

  - type: web
    name: price-ml-service
    env: docker
    plan: free
    dockerfilePath: ./ml_service/Dockerfile
    buildContext: .
    autoDeploy: true
    buildCommand: |
      pip install -r ml_service/requirements.txt
    startCommand: |
      uvicorn ml_service.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: MODEL_PATH
        value: /tmp/model.pkl
      - key: TEMP_DIR
        value: /tmp/price_api_temp

databases:
  - name: price-db
    plan: free
    databaseName: price_db
    user: price_user

  - type: redis
    name: price-redis
    plan: free
